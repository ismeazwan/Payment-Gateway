<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JagaNetwork - Cek & Bayar Tagihan</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        @media (max-width: 639px) {
            .responsive-table thead { display: none; }
            .responsive-table tbody tr {
                display: block; margin-bottom: 1rem; border: 1px solid #e5e7eb;
                border-radius: 0.5rem; padding: 0.5rem;
                box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            }
            .responsive-table tbody td {
                display: flex; justify-content: space-between; align-items: center;
                padding: 0.75rem; text-align: right;
            }
            .responsive-table tbody td:not(:last-child) { border-bottom: 1px solid #f3f4f6; }
            .responsive-table tbody td::before {
                content: attr(data-label); font-weight: 600; text-align: left;
                margin-right: 1rem; color: #6b7280;
            }
            .responsive-table tbody td[data-label="Status"] span { flex-shrink: 0; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-2xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-indigo-600">JagaNetwork</h1>
            <p class="text-gray-500 mt-2">Portal Pembayaran Tagihan Pelanggan</p>
        </header>

        <main>
            <!-- Input ID Section -->
            <div id="customer-id-input-section" class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">Cek Tagihan Anda</h2>
                <p class="text-gray-600 mb-4">Silakan masukkan ID Pelanggan Anda untuk melihat detail tagihan.</p>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="customer-id-input" placeholder="Masukkan 5 digit ID Pelanggan" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none transition" maxlength="5">
                    <button id="check-invoice-btn" class="w-full sm:w-auto bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition duration-300 font-medium flex items-center justify-center">
                        <i data-lucide="search" class="w-5 h-5 mr-2"></i>Cek Tagihan
                    </button>
                </div>
                <p id="error-message" class="text-red-500 text-sm mt-2 h-4"></p>
            </div>

            <!-- Invoice Details Section -->
            <div id="invoice-details-section" class="hidden mt-8">
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h3 class="text-lg font-semibold border-b pb-3 mb-4">Detail Pelanggan</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-500">ID Pelanggan</p>
                            <p id="detail-customer-id" class="font-semibold"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Nama</p>
                            <p id="detail-customer-name" class="font-semibold"></p>
                        </div>
                        <div class="col-span-1 sm:col-span-2">
                            <p class="text-sm text-gray-500">Alamat</p>
                            <p id="detail-customer-address" class="font-semibold"></p>
                        </div>
                        <div class="col-span-1 sm:col-span-2">
                            <p class="text-sm text-gray-500">Paket Layanan</p>
                            <p id="detail-customer-package" class="font-semibold"></p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-4">Daftar Tagihan</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left responsive-table">
                            <thead>
                                <tr class="border-b bg-gray-50">
                                    <th class="p-3">Periode Layanan</th>
                                    <th class="p-3">Jumlah</th>
                                    <th class="p-3">Status</th>
                                    <th class="p-3 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="invoice-table-body"></tbody>
                        </table>
                    </div>
                </div>
                 <div class="text-center mt-6">
                    <button id="change-id-btn" class="text-indigo-600 hover:underline">Ganti ID Pelanggan</button>
                </div>
            </div>
        </main>
    </div>
    
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white py-3 px-6 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <p id="toast-message"></p>
    </div>

    <!-- Modal Pembayaran Manual -->
    <div id="payment-modal" class="fixed inset-0 z-50 items-center justify-center hidden bg-black bg-opacity-50 overflow-y-auto p-4">
        <div class="bg-white rounded-lg shadow-lg p-6 md:p-8 w-11/12 max-w-md my-8">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-xl font-bold">Instruksi Pembayaran</h3>
                <button id="btn-close-payment-modal" class="text-2xl leading-none text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            
            <div class="space-y-4">
                <p class="text-gray-700">Silakan lakukan transfer sejumlah:</p>
                <p id="modal-invoice-amount" class="text-3xl font-bold text-center text-indigo-600 bg-indigo-50 py-3 rounded-lg"></p>
                
                <div>
                    <p class="text-gray-700 font-semibold">Transfer Bank:</p>
                    <div class="border rounded-lg p-3 mt-1 space-y-2">
                        <div>
                            <p class="font-semibold">Bank Mandiri</p>
                            <div class="flex justify-between items-center">
                                <p class="text-gray-600">No. Rek: <span class="font-mono">1180010207073</span></p>
                                <button class="btn-copy p-1 text-gray-500 hover:text-indigo-600" data-copy="1180010207073" aria-label="Salin nomor rekening Mandiri">
                                    <i data-lucide="copy" class="w-4 h-4 pointer-events-none"></i>
                                </button>
                            </div>
                            <p class="text-gray-600 text-sm">a/n ROHMAH</p>
                        </div>
                        <div class="border-t"></div>
                        <div>
                            <p class="font-semibold">SeaBank</p>
                             <div class="flex justify-between items-center">
                                <p class="text-gray-600">No. Rek: <span class="font-mono">901481081310</span></p>
                                <button class="btn-copy p-1 text-gray-500 hover:text-indigo-600" data-copy="901481081310" aria-label="Salin nomor rekening SeaBank">
                                    <i data-lucide="copy" class="w-4 h-4 pointer-events-none"></i>
                                </button>
                            </div>
                            <p class="text-gray-600 text-sm">a/n Muhamm Azwan W. M.</p>
                        </div>
                    </div>
                </div>

                <div>
                    <p class="text-gray-700 font-semibold">E-Wallet:</p>
                    <div class="border rounded-lg p-3 mt-1 space-y-2">
                         <div>
                            <p class="font-semibold">DANA / Gopay / ShopeePay</p>
                             <div class="flex justify-between items-center">
                                <p class="text-gray-600">No: <span class="font-mono">089503863887</span></p>
                                <button class="btn-copy p-1 text-gray-500 hover:text-indigo-600" data-copy="089503863887" aria-label="Salin nomor E-Wallet">
                                    <i data-lucide="copy" class="w-4 h-4 pointer-events-none"></i>
                                </button>
                            </div>
                            <p class="text-gray-600 text-sm">a/n Muhammad Azwan W. M.</p>
                        </div>
                    </div>
                </div>
                
                <p class="text-sm text-green-700 bg-green-50 p-3 rounded-lg mt-6">
                    <i data-lucide="info" class="inline w-4 h-4 mr-1"></i>
                    Setelah transfer, klik tombol di bawah ini untuk mengirim bukti pembayaran langsung ke Admin via WhatsApp.
                </p>
            </div>

            <div class="flex justify-end gap-4 mt-6">
                 <button type="button" id="btn-confirm-payment-wa" class="w-full bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 font-semibold flex items-center justify-center">
                    <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M16.75 13.96c.25.13.41.2.46.3.08.11.1.21.12.31.02.1-.02.21-.06.31s-.13.18-.21.23-.2.1-.28.13c-.08.03-.17.03-.25.03-.1 0-.19-.02-.28-.05-.1-.03-.2-.06-.3-.1s-.2-.1-.3-.15c-.28-.16-.54-.37-.8-.63-.26-.26-.5-.54-.73-.86s-.43-.67-.6-.98c-.18-.31-.31-.59-.4-.83-.09-.24-.13-.45-.13-.62s.01-.3.04-.42.08-.23.15-.31.15-.15.25-.2c.1-.05.2-.08.31-.08.11 0 .2.01.29.04s.16.06.22.1c.06.04.12.08.18.13s.11.1.15.16c.04.06.06.11.08.15.02.04.03.08.03.11s0 .09-.01.15l-.01.06-.27.99c-.06.22-.12.4-.2.53s-.16.23-.26.3c-.1.07-.2.1-.3.1s-.19-.02-.28-.07c-.09-.04-.18-.1-.26-.18s-.15-.15-.22-.24-.13-.18-.19-.28c-.06-.1-.13-.2-.2-.31-.07-.11-.13-.21-.19-.31-.22-.35-.33-.65-.33-.89 0-.25.06-.5.18-.73s.28-.43.48-.59.43-.28.7-.38c.27-.1.55-.14.85-.14.38 0 .73.07 1.04.2s.58.31.81.54.41.48.53.75.18.52.18.74c0 .08-.01.15-.03.23s-.04.15-.08.21-.08.14-.13.2zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10c1.79 0 3.48-.46 4.95-1.28l3.79 1.28-1.28-3.79c.82-1.47 1.28-3.16 1.28-4.95C22 6.48 17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"></path></svg>
                    Kirim Bukti Pembayaran ke Admin
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Pembayaran Selesai -->
    <div id="success-modal" class="fixed inset-0 z-50 items-center justify-center hidden bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-lg p-8 w-11/12 max-w-sm text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                <i data-lucide="check" class="h-8 w-8 text-green-600"></i>
            </div>
            <h3 class="text-xl font-bold">Pembayaran Selesai!</h3>
            <p class="text-gray-600 mt-2">Terima kasih, pembayaran Anda telah berhasil kami verifikasi.</p>
            <button id="btn-close-success-modal" class="mt-6 w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">OK</button>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, updateDoc, onSnapshot, 
            collection, query, where, getDocs
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
        const firebaseConfig = {
            apiKey: "AIzaSyBeuxfhsPRqd3NJTp0zUfnuZGJEKLBh3g0",
            authDomain: "database-jaganetwork.firebaseapp.com",
            projectId: "database-jaganetwork",
            storageBucket: "database-jaganetwork.appspot.com",
            messagingSenderId: "912989992875",
            appId: "1:912989992875:web:8c6cda77171889e1e644ee"
        };
    
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const dataContainerPath = "jaganetwork_data/shared_workspace";
        const getCollectionRef = (name) => collection(db, dataContainerPath, name);

        let currentCustomer = null;
        let unsubscribeInvoices = null;
        let currentCustomerInvoices = [];
        let allPackages = [];
        let invoiceToPay = null;

        const inputSection = document.getElementById('customer-id-input-section');
        const detailsSection = document.getElementById('invoice-details-section');
        const checkBtn = document.getElementById('check-invoice-btn');
        const customerIdInput = document.getElementById('customer-id-input');
        const errorMsg = document.getElementById('error-message');
        const changeIdBtn = document.getElementById('change-id-btn');
        
        const paymentModal = document.getElementById('payment-modal');
        const btnClosePaymentModal = document.getElementById('btn-close-payment-modal');
        const btnConfirmPaymentWa = document.getElementById('btn-confirm-payment-wa');

        const successModal = document.getElementById('success-modal');
        const btnCloseSuccessModal = document.getElementById('btn-close-success-modal');

        const showToast = (message, type = 'success') => {
            const toast = document.getElementById('toast'), msg = document.getElementById('toast-message');
            toast.className = 'fixed bottom-5 right-5 text-white py-3 px-6 rounded-lg shadow-lg transform transition-all duration-300 z-50';
            const typeClasses = { error: 'bg-red-600', info: 'bg-blue-600' };
            toast.classList.add(typeClasses[type] || 'bg-green-600');
            msg.textContent = message;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        const copyToClipboard = (text) => {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.top = '0';
            textArea.style.left = '0';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showToast('Nomor berhasil disalin!');
            } catch (err) {
                console.error('Gagal menyalin teks: ', err);
                showToast('Gagal menyalin nomor.', 'error');
            }
            document.body.removeChild(textArea);
        };

        const formatRupiah = (angka) => !angka ? '-' : new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka);
        
        const getBillingPeriodText = (invoice) => {
            const endDate = new Date(invoice.periode + 'T00:00:00');
            let startDate;
            if (invoice.isProrated && currentCustomer?.joinDate) {
                 startDate = new Date(currentCustomer.joinDate + 'T00:00:00');
            } else {
                 startDate = new Date(endDate.getFullYear(), endDate.getMonth() - 1, 8);
            }
            const options = { day: 'numeric', month: 'short', year: 'numeric' };
            return `${startDate.toLocaleDateString('id-ID', options)} - ${endDate.toLocaleDateString('id-ID', options)}`;
        }

        const renderInvoices = (allInvoices) => {
            const tbody = document.getElementById('invoice-table-body');
            const invoicesToDisplay = allInvoices.filter(inv => inv.status !== 'lunas');
            
            if (!invoicesToDisplay.length) {
                tbody.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-gray-500">Selamat, tidak ada tagihan yang perlu dibayar saat ini.</td></tr>`;
                return;
            }

            tbody.innerHTML = invoicesToDisplay
                .sort((a,b) => {
                    if (a.status === 'belum lunas' && b.status !== 'belum lunas') return -1;
                    if (a.status !== 'belum lunas' && b.status === 'belum lunas') return 1;
                    return b.periode.localeCompare(a.periode);
                })
                .map(inv => {
                    let statusText, statusClass, actionHtml;

                    if (inv.status === 'menunggu konfirmasi') {
                        statusText = 'Menunggu Verifikasi';
                        statusClass = 'bg-blue-100 text-blue-800';
                        actionHtml = `<span class="text-sm text-gray-500 italic">Diproses</span>`;
                    } else { // 'belum lunas'
                        statusText = 'Belum Lunas';
                        statusClass = 'bg-red-100 text-red-800';
                        actionHtml = `<button class="btn-pay-invoice bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm w-full" data-id="${inv.id}">Bayar Sekarang</button>`;
                    }

                    return `<tr>
                        <td data-label="Periode Layanan">${getBillingPeriodText(inv)}</td>
                        <td data-label="Jumlah">${formatRupiah(inv.jumlah)}</td>
                        <td data-label="Status"><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${statusText}</span></td>
                        <td data-label="Aksi">${actionHtml}</td>
                    </tr>`;
                }).join('');
                
            lucide.createIcons();
        };
        
        const openPaymentModal = (invoice) => {
            invoiceToPay = invoice;
            document.getElementById('modal-invoice-amount').textContent = formatRupiah(invoice.jumlah);
            paymentModal.style.display = 'flex';
            lucide.createIcons();
        };

        const closePaymentModal = () => {
            paymentModal.style.display = 'none';
            invoiceToPay = null;
        };

        const loadPackages = async () => {
            try {
                const querySnapshot = await getDocs(getCollectionRef('packages'));
                allPackages = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (err) {
                console.error("Error loading packages:", err);
            }
        };

        const checkCustomerAndLoadInvoices = async () => {
            const customerId = customerIdInput.value.trim();
            if (customerId.length !== 5) {
                errorMsg.textContent = 'ID Pelanggan harus 5 digit angka.'; return;
            }
            errorMsg.textContent = '';
            checkBtn.disabled = true;
            checkBtn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Mencari...`;

            try {
                const q = query(getCollectionRef('customers'), where("customerId", "==", customerId));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    errorMsg.textContent = 'ID Pelanggan tidak ditemukan.';
                    currentCustomer = null;
                } else {
                    const doc = querySnapshot.docs[0];
                    currentCustomer = { id: doc.id, ...doc.data() };

                    const pkg = allPackages.find(p => p.id === currentCustomer.paketId) || { nama: 'N/A', kecepatan: '' };
                    
                    document.getElementById('detail-customer-id').textContent = currentCustomer.customerId;
                    document.getElementById('detail-customer-name').textContent = currentCustomer.nama;
                    document.getElementById('detail-customer-address').textContent = currentCustomer.alamat;
                    document.getElementById('detail-customer-package').textContent = pkg ? `${pkg.nama} (${pkg.kecepatan})` : 'Tidak Terdaftar';


                    inputSection.classList.add('hidden');
                    detailsSection.classList.remove('hidden');

                    const invoiceQuery = query(getCollectionRef('invoices'), where("pelangganId", "==", currentCustomer.id));
                    if(unsubscribeInvoices) unsubscribeInvoices();
                    unsubscribeInvoices = onSnapshot(invoiceQuery, (snapshot) => {
                        const newInvoices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                        if (currentCustomerInvoices.length > 0) {
                            newInvoices.forEach(newInvoice => {
                                const oldInvoice = currentCustomerInvoices.find(old => old.id === newInvoice.id);
                                if (oldInvoice && oldInvoice.status !== 'lunas' && newInvoice.status === 'lunas') {
                                    successModal.style.display = 'flex';
                                    lucide.createIcons();
                                }
                            });
                        }
                        
                        currentCustomerInvoices = newInvoices;
                        renderInvoices(currentCustomerInvoices);
                    });
                }
            } catch (err) {
                console.error("Error checking customer:", err);
                errorMsg.textContent = 'Terjadi kesalahan saat mencari data.';
            } finally {
                checkBtn.disabled = false;
                checkBtn.innerHTML = `<i data-lucide="search" class="w-5 h-5 mr-2"></i> Cek Tagihan`;
                lucide.createIcons();
            }
        };
        
        const handleWhatsAppRedirect = async () => {
            if (!invoiceToPay || !currentCustomer) return;
            
            const adminWhatsappNumber = '6288973378384'; 

            const message = `Halo Admin, saya ingin konfirmasi pembayaran untuk:

Nama: *${currentCustomer.nama}*
ID Pelanggan: *${currentCustomer.customerId}*
Periode: *${getBillingPeriodText(invoiceToPay)}*
Jumlah: *${formatRupiah(invoiceToPay.jumlah)}*

Berikut bukti transfernya. Terima kasih.`;

            const whatsappUrl = `https://wa.me/${adminWhatsappNumber}?text=${encodeURIComponent(message)}`;
            
            try {
                const invoiceRef = doc(db, dataContainerPath, 'invoices', invoiceToPay.id);
                await updateDoc(invoiceRef, {
                    status: 'menunggu konfirmasi'
                });
                
                window.open(whatsappUrl, '_blank');
                
                closePaymentModal();
                showToast('Silakan kirim bukti pembayaran Anda di WhatsApp.', 'info');
            } catch (error) {
                console.error("Failed to update status before redirect:", error);
                showToast('Gagal memproses, silakan coba lagi.', 'error');
            }
        };

        // Event Listeners
        checkBtn.addEventListener('click', checkCustomerAndLoadInvoices);
        customerIdInput.addEventListener('keyup', (e) => {
             if (e.key === 'Enter') checkCustomerAndLoadInvoices();
        });
        
        changeIdBtn.addEventListener('click', () => {
            if(unsubscribeInvoices) unsubscribeInvoices();
            currentCustomer = null;
            currentCustomerInvoices = [];
            allPackages = [];
            customerIdInput.value = '';
            detailsSection.classList.add('hidden');
            inputSection.classList.remove('hidden');
            document.getElementById('invoice-table-body').innerHTML = '';
            errorMsg.textContent = '';
        });

        document.getElementById('invoice-table-body').addEventListener('click', (e) => {
            const payButton = e.target.closest('.btn-pay-invoice');
            if (payButton) {
                const invoiceId = payButton.dataset.id;
                const invoice = currentCustomerInvoices.find(inv => inv.id === invoiceId);
                if (invoice) {
                    openPaymentModal(invoice);
                }
            }
        });

        paymentModal.addEventListener('click', (e) => {
            const copyButton = e.target.closest('.btn-copy');
            if (copyButton) {
                const textToCopy = copyButton.dataset.copy;
                if (textToCopy) {
                    copyToClipboard(textToCopy);
                }
            }
        });

        btnClosePaymentModal.addEventListener('click', closePaymentModal);
        
        btnConfirmPaymentWa.addEventListener('click', handleWhatsAppRedirect);
        
        btnCloseSuccessModal.addEventListener('click', () => {
            successModal.style.display = 'none';
        });

        // Initialize
        lucide.createIcons();
        signInAnonymously(auth).then(() => {
            loadPackages(); // Muat data paket setelah berhasil login
        }).catch((error) => {
            console.error("Anonymous sign-in failed:", error);
            if (error.code === 'auth/admin-restricted-operation') {
                errorMsg.innerHTML = '<strong>Error Konfigurasi:</strong> Login anonim harus diaktifkan di Firebase Console.';
                checkBtn.disabled = true;
                customerIdInput.disabled = true;
            } else {
                errorMsg.textContent = "Tidak dapat terhubung ke server.";
            }
        });
    </script>
</body>
</html>

